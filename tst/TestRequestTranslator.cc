#include <gtest/gtest.h>
#include <gmock/gmock.h>

#include <array>
#include <memory>
#include <vector>
#include <string>

#include "../src/interfaces/ServerProtocol.h"
#include "../src/RequestTranslator.h"
#include "TestUtils.h"

using namespace gbx;
using namespace std;

using ::testing::Return;
using ::testing::_;

class RawEventSourceMock
{
public:
    RawEventSourceMock() = default;
    ~RawEventSourceMock() = default;

    void AddEventListener(std::shared_ptr<gbxcommons::Observer<interfaces::RawRequestEventArgs>> observer)
    {
        _observers.push_back(observer);
    }

    void NotifyObserver(array<uint8_t, interfaces::MaxRawRequestSize> message)
    {
        auto eventArgs = make_shared<interfaces::RawRequestEventArgs>(message);
        for (auto observer : _observers)
            observer->Notify(eventArgs);
    }

private:
    vector<std::shared_ptr<gbxcommons::Observer<interfaces::RawRequestEventArgs>>> _observers;
};

class RequestEventObserver : public gbxcommons::Observer<RequestEventArgs>
{
public:
    RequestEventObserver() = default;
    ~RequestEventObserver() = default;

    MOCK_METHOD(void, Notify, (std::shared_ptr<RequestEventArgs>));
};

TEST(TestRequestTranslator, Construction)
{
    auto requestTranslator = make_shared<RequestTranslator>();
}

TEST(TestRequestTranslator, TranslateRawRequest)
{
    array<uint8_t, interfaces::MaxRawRequestSize> request = 
    {{
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
    }};

    auto rawEventSource = make_shared<RawEventSourceMock>();
    auto requestTranslator = make_shared<RequestTranslator>();

    rawEventSource->AddEventListener(requestTranslator);
    rawEventSource->NotifyObserver(request);
}

TEST(TestRequestTranslator, NotifyListener)
{
    array<uint8_t, interfaces::MaxRawRequestSize> request = 
    {{
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
    }};

    auto rawEventSource = make_shared<RawEventSourceMock>();
    auto requestTranslator = make_shared<RequestTranslator>();
    auto requestObserver = make_shared<RequestEventObserver>();

    rawEventSource->AddEventListener(requestTranslator);
    requestTranslator->AddEventListener(requestObserver);

    EXPECT_CALL((*requestObserver), Notify(::_));
    rawEventSource->NotifyObserver(request);
}